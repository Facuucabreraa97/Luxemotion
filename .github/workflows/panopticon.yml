name: Project Panopticon - Sentinel

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

# OPTIMIZATION 1: Resource Guard (Auto-Cancel old runs)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sentinel-scan:
    runs-on: ubuntu-latest
    # OPTIMIZATION 2: Explicit Permissions for PR Creation
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run Tests (The Trigger)
        id: test_step
        run: npm test -- --passWithNoTests
        continue-on-error: true

      # THE BRAIN: AUTO-DISCOVERY + GEMINI
      - name: Run Surgeon Analysis (Gemini Powered)
        if: steps.test_step.outcome == 'failure'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: node scripts/analyze_failure.js

      # THE FIX: NATIVE PR + VISUAL REPORTING (The "God Mode" Upgrade)
      - name: Create Self-Healing Pull Request
        if: failure() || steps.test_step.outcome == 'failure'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Validation: Check if patch exists and is not empty
          if [ -s patches/fix-ai.diff ]; then
            echo "ðŸ©¹ Patch detected. Initiating repair protocol..."
            
            # 2. Git Identity Configuration
            git config --global user.name "Sentinel AI"
            git config --global user.email "sentinel@mivideoai.com"
            
            # 3. Collision-Proof Branching
            BRANCH_NAME="fix/sentinel-auto-${{ github.run_id }}"
            git checkout -b $BRANCH_NAME
            
            # 4. Apply Patch & Commit
            git apply patches/fix-ai.diff
            git add .
            git commit -m "ðŸ©¹ Sentinel Fix: Auto-Repair via Google Gemini"
            git push origin $BRANCH_NAME
            
            # 5. Create PR via Native CLI
            PR_URL=$(gh pr create \
              --title "ðŸ›¡ï¸ Sentinel Auto-Fix: Repair detected failure" \
              --body "### ðŸ¤– Sentinel Report via Google Gemini
              **Diagnosis:** Test suite failure detected.
              **Action:** Applied automated patch generated by AI.
              **Status:** Ready for human review.
              
              *Powered by Antigravity Protocol*" \
              --base main \
              --head $BRANCH_NAME)
            
            echo "âœ… PR Created: $PR_URL"
            
            # 6. VISUAL SUMMARY (Write to GitHub Actions UI)
            echo "### ðŸ›¡ï¸ Sentinel Mission Report" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Threat Neutralized**" >> $GITHUB_STEP_SUMMARY
            echo "- **Patch Applied:** Yes" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch:** \`$BRANCH_NAME\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Pull Request:** $PR_URL" >> $GITHUB_STEP_SUMMARY
            
          else
            echo "âš ï¸ No patch generated. Sentinel standing down."
            echo "### ðŸ›¡ï¸ Sentinel Status: Idle" >> $GITHUB_STEP_SUMMARY
            echo "No patch was generated by the AI Surgeon." >> $GITHUB_STEP_SUMMARY
          fi
