name: Sentinel Omega
on: [push, workflow_dispatch]

concurrency: 
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  sentinel-scan:
    runs-on: ubuntu-latest
    permissions: { contents: write, pull-requests: write }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      # Force Projection: Continue even if tests fail
      - run: npm test -- --passWithNoTests || echo "⚠️ Tests skipped"
      - name: Run Atomic Brain
        run: node scripts/analyze_failure.js
        env: { GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }} }
      - name: Detect & Commit Atomic Changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "⚡ Changes detected. Committing..."
            git config user.name "Sentinel Omega"
            git config user.email "sentinel@antigravity.dev"
            
            BRANCH_NAME="fix/atomic-${{ github.run_id }}"
            git checkout -b "$BRANCH_NAME"
            
            git add .
            # OMEGA OVERRIDE: --no-verify
            git commit --no-verify -m "⚡ Sentinel Atomic Rewrite"
            git push origin "$BRANCH_NAME"
            
            gh pr create --title "⚡ Sentinel Atomic Fix" --body "Protocol: Atomic Rewrite via Google Gemini." --base main --head "$BRANCH_NAME"
          else
             echo "✅ No Atomic Rewrites needed."
          fi
        env: { GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} }
